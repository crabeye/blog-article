<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="Bill Lee's Blog" href="https://blog.liq2.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="Bill Lee's Blog" href="https://blog.liq2.com/atom.xml"><link rel="alternate" type="application/json" title="Bill Lee's Blog" href="https://blog.liq2.com/feed.json"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="分布式事务,spring cloud网关"><link rel="canonical" href="https://blog.liq2.com/article/62ceeeec.html"><title>分布式事务解决方案 - 微服务 - Java - 后端 | Climb Crab = Bill Lee's Blog = 码农的马，谢谢的蟹</title><meta name="generator" content="Hexo 6.2.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">分布式事务解决方案</h1><div class="meta"><span class="item" title="创建时间：2022-06-22 09:07:23"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2022-06-22T09:07:23+08:00">2022-06-22</time></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Climb Crab</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><img src="https://fastly.jsdelivr.net/gh/crabeye/site-asserts/blog/article-files/2022/06/seata_tcc-1.jpg"></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/backend/" itemprop="item" rel="index" title="分类于 后端"><span itemprop="name">后端</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/backend/java/" itemprop="item" rel="index" title="分类于 Java"><span itemprop="name">Java</span></a><meta itemprop="position" content="2"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/backend/java/micro-service/" itemprop="item" rel="index" title="分类于 微服务"><span itemprop="name">微服务</span></a><meta itemprop="position" content="3"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.liq2.com/article/62ceeeec"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Bill Lee"><meta itemprop="description" content="码农的马，谢谢的蟹, 好记性不如烂笔头"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Bill Lee's Blog"></span><div class="body md" itemprop="articleBody"><p>事务，大多时候我们是说在单体应用情况下，把多个操作整体执行的能力，分布式事务，就是在多个应用甚至多个数据源的情况下，保证操作的事务特性，在开始之前先回顾一下事务的相关基础知识</p><h1 id="一-基础概念"><a class="anchor" href="#一-基础概念">#</a> 一、基础概念</h1><p>举一个例子，我们有一个网上商城平台，用户下单购买商品，商品的库存减少，同时产生一条订单记录，订单上这个商品的数量就是商品库存的数量，事务在这个例子上表现就是在下单前和下单之后，商品的总数量是不变的。</p><p>我们以这个例子来说明一下事务和分布式事务：</p><h2 id="1事务"><a class="anchor" href="#1事务">#</a> 1. 事务</h2><p>上面例子涉及到两个数据库操作</p><ul><li>在库存表减少商品的库存数量</li><li>新增一个订单记录订单购买的商品数量</li></ul><p>这两个操作必须作为一个整体执行，要么两个都成功，要么两个都执行失败，这就是事务了，事务具有 ACID 四个基本特性</p><ol><li><p><strong>Atomicity（原子性）</strong>：一个事务中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被恢复到事务开始前的状态，就像这个事务从来没有执行过一样。</p></li><li><p><strong>Consistency（一致性）</strong>：在事务开始之前和事务结束以后，数据库的完整性没有被破坏。完整性包括外键约束、应用定义的等约束不会被破坏。</p></li><li><p><strong>Isolation（隔离性）</strong>：数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。</p><p>四种隔离级别比较</p><table><thead><tr><th></th><th><strong>脏读</strong></th><th><strong>不可重复读</strong></th><th><strong>幻读</strong></th></tr></thead><tbody><tr><td><strong>读未提交</strong></td><td>可能</td><td>可能</td><td>可能</td></tr><tr><td><strong>读已提交</strong></td><td>不会</td><td>可能</td><td>可能</td></tr><tr><td><strong>可重复读</strong></td><td>不会</td><td>不会</td><td>可能</td></tr><tr><td><strong>串行化</strong></td><td>不会</td><td>不会</td><td>不会</td></tr></tbody></table><p>串行化是最高的事务隔离级别，同时代价也花费最高，性能很低，一般很少使用，在该级别下，事务顺序执行，不仅可以避免脏读、不可重复读，还避免了幻读</p></li><li><p><strong>Durability（持久性）</strong>：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。</p></li></ol><h2 id="2分布式事务"><a class="anchor" href="#2分布式事务">#</a> 2. 分布式事务</h2><p>分布式事务就是指事务的发起者、资源及资源管理器和事务协调者分别位于分布式系统的不同节点之上，由于分布式应用可能部署在不一样的机器上，所以一般都需要一个事务协调者对事务进行统一调度，来控制事务的提交和撤回，本质上来说，分布式事务就是为了保证在分布式场景下，数据操作的正确执行。</p><p>根据 BASE 理论，分布式事务需要在数据一致性和实时性根据业务需要做出必要协调，基本思想包含以下三种情况：</p><ul><li><p><strong>B</strong>asic <strong>A</strong>vailability 基本业务可用性</p><p>分布式系统再出现故障时，允许损失部分可用功能，保证核心功能可用，如电商网站交易付款出现问题了，商品浏览仍然可以访问。</p></li><li><p><strong>S</strong>oft state 柔性事务</p><p>由于不要求强一致性，所以 BASE 系统中允许存在中间状态（也叫软状态），这个状态不影响系统可用性，如订单的 “支付中”，“数据同步中” 等状态，待数据最终一致后，状态改为 “成功” 状态</p></li><li><p><strong>E</strong>ventual consistency 最终一致性</p><p>是指经过一段时间后，所有数据都将达到一致。如订单中的 “支付中” 状态，最终会变为 “支付成功” 或 “支付失败”，使订单状态与实际交易结果达成一致，但需要一定的延迟等待</p></li></ul><p>当然，分布式事务也遵循 ACID 基本特性，但是在一致性和隔离性方面允许在实时方面做出一定让步</p><h1 id="二-分布式事务解决方案"><a class="anchor" href="#二-分布式事务解决方案">#</a> 二、分布式事务解决方案</h1><p>根据现有的分布式理论和现有的分布式框架，可以归纳以下几种解决方案</p><h2 id="1两阶段提交-two-phase-commit-又称-xc"><a class="anchor" href="#1两阶段提交-two-phase-commit-又称-xc">#</a> 1. 两阶段提交 (Two Phase Commit, 又称 XC)</h2><p>二阶段提交 (Two-phaseCommit) 是指，在计算机网络以及数据库领域内，为了使基于分布式系统架构下的所有节点在进行事务提交时<strong>保持一致性</strong>而设计的一种算法 (Algorithm)。通常，二阶段提交也被称为是一种协议 (Protocol))。<strong>当一个事务跨越多个节点时</strong>，<strong>为了保持事务的 ACID 特性</strong>，需要<strong>引入一个作为协调者的组件 TM (Transaction Manage)</strong> 来统一掌控所有节点 (称作参与者或者资源管理者<strong> Resource Manage</strong>) 的操作结果并最终指示这些节点是否要把操作结果进行真正的提交 (比如将更新后的数据写入磁盘等等)。</p><h3 id="a两阶段说明"><a class="anchor" href="#a两阶段说明">#</a> a. 两阶段说明</h3><ul><li><p><strong>投票阶段 (Voting Phase 又叫准备阶段)</strong></p><p>这个阶段由主程序进行 TM 的创建，完成所有 RM 在 TM 上的注册之后完成以下三个过程</p><ul><li>协调者的询问 下图 1 步骤</li><li>资源管理者的事务执行 下图 1.1</li><li>资源管理者反馈执行信息 下图 1.2</li></ul></li><li><p><strong>提交阶段 (Commit Phase 又叫执行阶段)</strong></p><p>​	步骤根据准备阶段提交的通知，进行提交或者回滚处理</p><ul><li>如果所有 RM 都成功执行，则通知所有节点进行事务提交</li><li>反之有一个或多个 RM 执行失败，则通知所有节点进行回滚操作</li></ul></li></ul><pre class="mermaid"><svg id="mermaid-1656492933899" width="100%" xmlns="http://www.w3.org/2000/svg" height="509" style="max-width:616.5px" viewBox="-50 -10 616.5 509"><g></g><g><line id="actor0" x1="75" y1="5" x2="75" y2="498" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor:middle;font-size:14px;font-weight:400;font-family:Open-Sans,sans-serif"><tspan x="75" dy="0">事务协调者TM</tspan></text></g><g><line id="actor1" x1="431" y1="5" x2="431" y2="498" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="356" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="431" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor:middle;font-size:14px;font-weight:400;font-family:Open-Sans,sans-serif"><tspan x="431" dy="0">资源管理者RM</tspan></text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray:0,0"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray:0,0"></path></marker></defs><defs><marker id="sequencenumber" refX="15" refY="15" markerWidth="60" markerHeight="40" orient="auto"><circle cx="15" cy="15" r="6"></circle></marker></defs><text x="253" y="80" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family:&quot;font-size:16px;font-weight:400">1.询问各个资源管理者是否可以正常执行</text><line x1="75" y1="113" x2="431" y2="113" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill:none"></line><text x="431" y="128" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family:&quot;font-size:16px;font-weight:400">1.1 执行事务但不提交</text><path d="M 431,161 C 491,151 491,191 431,181" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill:none"></path><text x="253" y="206" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family:&quot;font-size:16px;font-weight:400">1.2 所有参与者都能成功执行事务</text><line x1="431" y1="239" x2="75" y2="239" class="messageLine1" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="stroke-dasharray:3,3;fill:none"></line><text x="253" y="254" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family:&quot;font-size:16px;font-weight:400">2.向所有通知者发送提交通知</text><line x1="75" y1="287" x2="431" y2="287" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill:none"></line><text x="431" y="302" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family:&quot;font-size:16px;font-weight:400">2.1 提交事务，释放资源</text><path d="M 431,335 C 491,325 491,365 431,355" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill:none"></path><text x="253" y="380" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family:&quot;font-size:16px;font-weight:400">2.2 反馈事务执行结果</text><line x1="431" y1="413" x2="75" y2="413" class="messageLine1" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="stroke-dasharray:3,3;fill:none"></line><g><rect x="0" y="433" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="465.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor:middle;font-size:14px;font-weight:400;font-family:Open-Sans,sans-serif"><tspan x="75" dy="0">事务协调者TM</tspan></text></g><g><rect x="356" y="433" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="431" y="465.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor:middle;font-size:14px;font-weight:400;font-family:Open-Sans,sans-serif"><tspan x="431" dy="0">资源管理者RM</tspan></text></g></svg></pre><blockquote><p>1）协调者节点向所有参与者节点发出” 正式提交 (commit)” 的请求。<br>2）参与者节点正式完成操作，并释放在整个事务期间内占用的资源。<br>3）参与者节点向协调者节点发送” 完成” 消息。<br>4）协调者节点受到所有参与者节点反馈的” 完成” 消息后，完成事务。</p><p>上图为了表达两阶段的过程，简化实际的步骤，去除了主程序创建 TM 的操作和 RM 注册到 TM 的操作</p></blockquote><h3 id="b两阶段提交的特点"><a class="anchor" href="#b两阶段提交的特点">#</a> b. 两阶段提交的特点</h3><ul><li><p>简单易理解，开发较容易</p></li><li><p>对资源进行了长时间的锁定，并发度低</p></li><li><p>单点故障问题</p><p>由于协调者的重要性，<strong>一旦协调者发生故障。参与者会一直阻塞下去。</strong><br>尤其在第二阶段，协调者发生故障，那么所有的参与者还都处于<strong>锁定事务资源的状态中</strong>，而无法继续完成事务操作</p><p>【协调者发出 Commit 消息<strong>之前</strong>宕机的情况】<br>（如果是协调者挂掉，可以重新选举一个协调者，但是<strong>无法解决因为协调者宕机导致的参与者处于阻塞状态的问题</strong>）</p></li><li><p><strong>数据不一致</strong></p><p>在二阶段提交的<strong>阶段二中</strong>，当协调者向参与者发送 commit 请求之后，发生了局部网络异常或者在发送 commit 请求过程中协调者发生了故障，这回导致只有一部分参与者接受到了 commit 请求。而在这部分参与者接到 commit 请求之后就会执行 commit 操作。但是其他部分未接到 commit 请求的机器则无法执行事务提交。于是整个分布式系统便出现了数据不一致性的现象。</p></li></ul><h2 id="2三阶段提交three-phase-commit"><a class="anchor" href="#2三阶段提交three-phase-commit">#</a> 2. 三阶段提交 (Three Phase Commit)</h2><p>由于二阶段提交存在着诸如<strong>同步阻塞、单点问题、脑裂</strong>等缺陷，所以，研究者们在二阶段提交的基础上做了改进，提出了三阶段提交</p><blockquote><p>三阶段提交（Three-phase commit），也叫三阶段提交协议（Three-phase commit protocol），是二阶段提交（2PC）的改进版本。与两阶段不同的是加入了两个不同点</p><p>1、引入<strong>超时机制</strong>。同时在协调者和参与者中都引入超时机制。<br>2、在第一阶段和第二阶段中插入一个 ** 准备阶段，** 保证了在最后提交阶段之前各参与节点状态的一致。</p></blockquote><h3 id="a三阶段定义"><a class="anchor" href="#a三阶段定义">#</a> a. 三阶段定义</h3><p>三阶段其实就是把两阶段的投票阶段一分为二，于是有了以下三阶段</p><ul><li>CanCommit 阶段</li><li>PreCommit 阶段</li><li>DoCommit 阶段</li></ul><pre class="mermaid"><svg id="mermaid-1656492935363" width="100%" xmlns="http://www.w3.org/2000/svg" height="683" style="max-width:583.5px" viewBox="-50 -10 583.5 683"><g></g><g><line id="actor0" x1="75" y1="5" x2="75" y2="672" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor:middle;font-size:14px;font-weight:400;font-family:Open-Sans,sans-serif"><tspan x="75" dy="0">TM</tspan></text></g><g><line id="actor1" x1="306" y1="5" x2="306" y2="672" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="231" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="306" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor:middle;font-size:14px;font-weight:400;font-family:Open-Sans,sans-serif"><tspan x="306" dy="0">RM</tspan></text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray:0,0"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray:0,0"></path></marker></defs><defs><marker id="sequencenumber" refX="15" refY="15" markerWidth="60" markerHeight="40" orient="auto"><circle cx="15" cy="15" r="6"></circle></marker></defs><text x="191" y="80" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family:&quot;font-size:16px;font-weight:400">第一阶段：canCommit</text><line x1="75" y1="113" x2="306" y2="113" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill:none"></line><text x="306" y="128" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family:&quot;font-size:16px;font-weight:400">检查时候能执行事务</text><path d="M 306,161 C 366,151 366,191 306,181" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill:none"></path><text x="191" y="206" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family:&quot;font-size:16px;font-weight:400">yes</text><line x1="306" y1="239" x2="75" y2="239" class="messageLine1" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="stroke-dasharray:3,3;fill:none"></line><text x="191" y="254" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family:&quot;font-size:16px;font-weight:400">第二阶段：preCommit</text><line x1="75" y1="287" x2="306" y2="287" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill:none"></line><text x="306" y="302" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family:&quot;font-size:16px;font-weight:400">执行事务操作，将undo和redo信息记录到事务日志</text><path d="M 306,335 C 366,325 366,365 306,355" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill:none"></path><text x="191" y="380" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family:&quot;font-size:16px;font-weight:400">Ack</text><line x1="306" y1="413" x2="75" y2="413" class="messageLine1" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="stroke-dasharray:3,3;fill:none"></line><text x="191" y="428" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family:&quot;font-size:16px;font-weight:400">第三阶段：doCommit</text><line x1="75" y1="461" x2="306" y2="461" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill:none"></line><text x="306" y="476" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family:&quot;font-size:16px;font-weight:400">提交事务</text><path d="M 306,509 C 366,499 366,539 306,529" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="fill:none"></path><text x="191" y="554" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family:&quot;font-size:16px;font-weight:400">commited</text><line x1="306" y1="587" x2="75" y2="587" class="messageLine1" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" style="stroke-dasharray:3,3;fill:none"></line><g><rect x="0" y="607" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="639.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor:middle;font-size:14px;font-weight:400;font-family:Open-Sans,sans-serif"><tspan x="75" dy="0">TM</tspan></text></g><g><rect x="231" y="607" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="306" y="639.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor:middle;font-size:14px;font-weight:400;font-family:Open-Sans,sans-serif"><tspan x="306" dy="0">RM</tspan></text></g></svg></pre><blockquote><p><strong>为什么要把投票阶段一分为二？</strong></p><p><strong>假设有 1 个协调者，9 个参与者。其中有一个参与者不具备执行该事务的能力。</strong><br>协调者发出 prepare 消息之后，其余参与者都将资源锁住，执行事务，写入 undo 和 redo 日志。<br>协调者收到相应之后，发现有一个参与者不能参与。所以，又出一个 roolback 消息。其余 8 个参与者，又对消息进行回滚。这样子，是不是做了很多无用功？<br>所以 **，** 引入 can-Commit 阶段，<strong>主要是为了在预执行之前，保证所有参与者都具备可执行条件，从而减少资源浪费。</strong></p></blockquote><h3 id="b具体执行过程"><a class="anchor" href="#b具体执行过程">#</a> b. 具体执行过程</h3><ul><li><strong>CanCommit 阶段</strong></li></ul><p>3PC 的 CanCommit 阶段其实和 2PC 的准备阶段很像。协调者向参与者发送 commit 请求，参与者如果可以提交就返回 Yes 响应，否则返回 No 响应。</p><blockquote><p><strong>1. 事务询问</strong> 协调者向参与者发送 CanCommit 请求。询问是否可以执行事务提交操作。然后开始等待参与者的响应。<br><strong>2. 响应反馈</strong> 参与者接到 CanCommit 请求之后，正常情况下，如果其自身认为可以顺利执行事务，则返回 Yes 响应，并进入预备状态。否则反馈 No</p></blockquote><ul><li><strong>PreCommit 阶段</strong></li></ul><p>本阶段协调者会根据第一阶段的询盘结果采取相应操作，询盘结果主要有两种：</p><p>** 情况 1-** 假如协调者从所有的参与者获得的反馈都是 Yes 响应，那么就会执行事务的预执行：</p><blockquote><p><strong>1. 发送预提交请求</strong> 协调者向参与者发送 PreCommit 请求，并进入 Prepared 阶段。<br><strong>2. 事务预提交</strong> 参与者接收到 PreCommit 请求后，会执行事务操作，并将 undo 和 redo 信息记录到事务日志中。<br><strong>3. 响应反馈</strong> 如果参与者成功的执行了事务操作，则返回 ACK 响应，同时开始等待最终指令。</p></blockquote><p>** 情况 2-** 假如有任何一个参与者向协调者发送了 No 响应，或者等待超时之后，协调者都没有接到参与者的响应，那么就执行事务的中断。具体步骤如下：</p><blockquote><p><strong>1. 发送中断请求</strong> 协调者向所有参与者发送 abort 请求。<br><strong>2. 中断事务</strong> 参与者收到来自协调者的 abort 请求之后（或超时之后，仍未收到协调者的请求），执行事务的中断。</p></blockquote><ul><li><strong>doCommit 阶段</strong></li></ul><p>该阶段进行真正的事务提交，也可以分为以下两种情况。</p><p><strong>情况 1 - 执行提交</strong></p><p>针对第一种情况，协调者向各个参与者发起事务提交请求，具体步骤如下：</p><blockquote><p>1. 协调者向所有参与者发送事务 commit 通知<br>2. 所有参与者在收到通知之后执行 commit 操作，并释放占有的资源<br>3. 参与者向协调者反馈事务提交结果</p></blockquote><p><strong>情况 2 - 中断事务</strong></p><p>协调者没有接收到参与者发送的 ACK 响应（可能是接受者发送的不是 ACK 响应，也可能响应超时），那么就会执行中断事务。具体步骤如下：</p><blockquote><p>1.<strong> 发送中断请求</strong> 协调者向所有参与者发送事务 rollback 通知。<br>2.<strong> 事务回滚</strong> 所有参与者在收到通知之后执行 rollback 操作，并释放占有的资源。<br>3.<strong> 反馈结果</strong> 参与者向协调者反馈事务提交结果。<br>4.<strong> 中断事务</strong> 协调者接收到参与者反馈的 ACK 消息之后，执行事务的中断。</p></blockquote><h2 id="3saga"><a class="anchor" href="#3saga">#</a> 3.SAGA</h2><h3 id="a基本概念"><a class="anchor" href="#a基本概念">#</a> a. 基本概念</h3><p>Saga 是这一篇数据库论文 saga 提到的一个方案。其核心思想是将长事务拆分为多个本地短事务，由 Saga 事务协调器协调，如果正常结束那就正常完成，如果某个步骤失败，则根据相反顺序一次调用补偿操作。</p><p>在 Saga 模式中：</p><ul><li><em>可补偿事务</em> 是通过处理另一个具有相反效果的事务来撤消的事务。</li><li><em>透视事务</em>是传奇中的 go/no-go 点。 如果透视事务提交，则 saga 将运行到完成为止。 透视事务可以是既不可补偿也不可重试的事务，也可以是最后一个可补偿事务，也可以是传奇中的第一个可重试事务。</li><li><em>可重试事务</em> 是遵循透视事务且保证成功事务的事务。</li></ul><p>有两种常见的传奇实现方法， <em>即编舞</em> 和 <em>业务流程</em>。 每个方法都有自己的一组挑战和技术来协调工作流。</p><h3 id="bsaga事务的特点"><a class="anchor" href="#bsaga事务的特点">#</a> b.SAGA 事务的特点：</h3><ul><li>并发度高，不用像 XA 事务那样长期锁定资源</li><li>需要定义正常操作以及补偿操作，开发量比 XA 大</li><li>一致性较弱，对于转账，可能发生 A 用户已扣款，最后转账又失败的情况</li></ul><p>论文里面的 SAGA 内容较多，包括两种恢复策略，包括分支事务并发执行，我们这里的讨论，仅包括最简单的 SAGA</p><p>SAGA 适用的场景较多，长事务适用，对中间结果不敏感的业务场景适用</p><p>如果读者想要进一步研究 SAGA，go 语言可参考 DTM，java 语言可参考 seata</p><h2 id="4tcc-try-confirm-cancel"><a class="anchor" href="#4tcc-try-confirm-cancel">#</a> 4.TCC (Try-Confirm-Cancel)</h2><h3 id="a基本概念-2"><a class="anchor" href="#a基本概念-2">#</a> a. 基本概念</h3><p>关于 TCC（Try-Confirm-Cancel）的概念，最早是由 Pat Helland 于 2007 年发表的一篇名为《Life beyond Distributed Transactions:an Apostate’s Opinion》的论文提出。</p><p><img data-src="https://fastly.jsdelivr.net/gh/crabeye/site-asserts/blog/article-files/2022/06/seata_tcc-1.jpg" alt=""></p><p><strong>TCC 分为 3 个阶段</strong></p><ul><li>Try 阶段：尝试执行，完成所有业务检查（一致性）, 预留必须业务资源（准隔离性）</li><li>Confirm 阶段：确认执行真正执行业务，不作任何业务检查，只使用 Try 阶段预留的业务资源，Confirm 操作要求具备幂等设计，Confirm 失败后需要进行重试。</li><li>Cancel 阶段：取消执行，释放 Try 阶段预留的业务资源。Cancel 阶段的异常和 Confirm 阶段异常处理方案基本上一致，要求满足幂等设计。</li></ul><p>把上面商城下单为例，在 try 阶段会冻结商品的库存数量，并不真正减少库存，而是在 Confirm 里面进行库存的扣减，Cancel 里进行库存解冻。</p><pre class="mermaid graph"><svg id="mermaid-1656492937230" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="113" style="max-width:559.52px" viewBox="0 1 559.515625 113"><g><g class="output"><g class="clusters"></g><g class="edgePaths"><g class="edgePath LS-A LE-B" id="L-A-B" style="opacity:1"><path class="path" d="M112.40625,37.46713409290096L167.171875,17.5L226.28125,37" marker-end="url(#arrowhead20)" style="fill:none"></path><defs><marker id="arrowhead20" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width:1;stroke-dasharray:1,0"></path></marker></defs></g><g class="edgePath LS-B LE-C" id="L-B-C" style="opacity:1"><path class="path" d="M348.84375,56.5L401.4609375,56.5L454.078125,56.5" marker-end="url(#arrowhead21)" style="fill:none"></path><defs><marker id="arrowhead21" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width:1;stroke-dasharray:1,0"></path></marker></defs></g><g class="edgePath LS-B LE-A" id="L-B-A" style="opacity:1"><path class="path" d="M221.9375,56.5L167.171875,56.5L112.40625,56.5" marker-end="url(#arrowhead22)" style="fill:none"></path><defs><marker id="arrowhead22" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width:1;stroke-dasharray:1,0"></path></marker></defs></g><g class="edgePath LS-B LE-A" id="L-B-A" style="opacity:1"><path class="path" d="M226.28125,76L167.171875,95.5L112.40625,75.53286590709904" marker-end="url(#arrowhead23)" style="fill:none"></path><defs><marker id="arrowhead23" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width:1;stroke-dasharray:1,0"></path></marker></defs></g></g><g class="edgeLabels"><g class="edgeLabel" transform="translate(167.171875,17.5)" style="opacity:1"><g transform="translate(-10.28125,-9.5)" class="label"><rect rx="0" ry="0" width="20.5625" height="19"></rect><text><tspan xml:space="preserve" dy="1em" x="1">try</tspan></text></g></g><g class="edgeLabel" transform="translate(401.4609375,56.5)" style="opacity:1"><g transform="translate(-27.6171875,-9.5)" class="label"><rect rx="0" ry="0" width="55.234375" height="19"></rect><text><tspan xml:space="preserve" dy="1em" x="1">confirm</tspan></text></g></g><g class="edgeLabel" transform="translate(167.171875,56.5)" style="opacity:1"><g transform="translate(-24.1875,-9.5)" class="label"><rect rx="0" ry="0" width="48.375" height="19"></rect><text><tspan xml:space="preserve" dy="1em" x="1">Cancel</tspan></text></g></g><g class="edgeLabel" transform="translate(167.171875,95.5)" style="opacity:1"><g transform="translate(-29.765625,-9.5)" class="label"><rect rx="0" ry="0" width="59.53125" height="19"></rect><text><tspan xml:space="preserve" dy="1em" x="1">Timeout</tspan></text></g></g></g><g class="nodes"><g class="node default" id="flowchart-A-8" transform="translate(60.203125,56.5)" style="opacity:1"><rect rx="5" ry="5" x="-52.203125" y="-19.5" width="104.40625" height="39" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-42.203125,-9.5)"><text><tspan xml:space="preserve" dy="1em" x="1">Initial State</tspan></text></g></g></g><g class="node default" id="flowchart-B-9" transform="translate(285.390625,56.5)" style="opacity:1"><rect rx="5" ry="5" x="-63.453125" y="-19.5" width="126.90625" height="39" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-53.453125,-9.5)"><text><tspan xml:space="preserve" dy="1em" x="1">Reserved State</tspan></text></g></g></g><g class="node default" id="flowchart-C-11" transform="translate(502.796875,56.5)" style="opacity:1"><rect rx="5" ry="5" x="-48.71875" y="-19.5" width="97.4375" height="39" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-38.71875,-9.5)"><text><tspan xml:space="preserve" dy="1em" x="1">Final State</tspan></text></g></g></g></g></g></g></svg></pre><h3 id="btcc特点"><a class="anchor" href="#btcc特点">#</a> b.TCC 特点</h3><ul><li><p>并发度较高，无长期资源锁定。</p></li><li><p>开发量较大，需要提供 Try/Confirm/Cancel 接口。</p></li><li><p><strong>一致性较好，不会发生 SAGA 已扣款最后又转账失败的情况</strong></p></li><li><p>TCC 适用于订单类业务，对中间状态有约束的业务</p></li><li><p>若【发起方】/【参与方】因崩溃遗失了信息，则会造成有的【参与方】已 Confirm，有的【参与方】则被 Cancel 了，甚至于依然保持在预留状态。</p></li></ul><h2 id="5本地消息表"><a class="anchor" href="#5本地消息表">#</a> 5. 本地消息表</h2><p>本地消息表这个方案最初是 ebay 架构师 Dan Pritchett 在 2008 年发表给 ACM 的文章。设计核心是将需要分布式处理的任务通过消息的方式来异步确保执行。</p><p>以前面商城下单为例，本地消息表的执行过程如下：</p><p><img data-src="https://fastly.jsdelivr.net/gh/crabeye/site-asserts/blog/article-files/2022/06/20220622170428.png" alt=""></p><p>写本地消息和业务操作放在一个事务里，保证了业务和发消息的原子性，要么他们全都成功，要么全都失败。</p><p><strong>容错机制：</strong></p><ul><li>扣减余额事务 失败时，事务直接回滚，无后续步骤</li><li>轮序生产消息失败， 增加余额事务失败都会进行重试</li></ul><p><strong>本地消息表的特点：</strong></p><ul><li>长事务仅需要分拆成多个任务，使用简单</li><li>生产者需要额外的创建消息表</li><li>每个本地消息表都需要进行轮询</li><li>消费者的逻辑如果无法通过重试成功，那么还需要更多的机制，来回滚操作</li></ul><p>适用于可异步执行的业务，且后续操作无需回滚的业务</p><h2 id="6事务消息"><a class="anchor" href="#6事务消息">#</a> 6. 事务消息</h2><p>在上述的本地消息表方案中，生产者需要额外创建消息表，还需要对本地消息表进行轮询，业务负担较重。阿里开源的 RocketMQ 4.3 之后的版本正式支持事务消息，该事务消息本质上是把本地消息表放到 RocketMQ 上（实际上就是把上图 2 的步骤使用支持事务的消息队列替换），解决生产端的消息发送与本地事务执行的原子性问题。</p><p>事务消息发送及提交：</p><ul><li>发送消息（half 消息）</li><li>服务端存储消息，并响应消息的写入结果</li><li>根据发送结果执行本地事务（如果写入失败，此时 half 消息对业务不可见，本地逻辑不执行）</li><li>根据本地事务状态执行 Commit 或者 Rollback（Commit 操作发布消息，消息对消费者可见）</li></ul><p><strong>补偿流程：</strong></p><p>对没有 Commit/Rollback 的事务消息（pending 状态的消息），从服务端发起一次 “回查”</p><p>Producer 收到回查消息，返回消息对应的本地事务的状态，为 Commit 或者 Rollback</p><p>事务消息方案与本地消息表机制非常类似，区别主要在于原先相关的本地表操作替换成了一个反查接口</p><p><strong>事务消息特点如下：</strong></p><ul><li>长事务仅需要分拆成多个任务，并提供一个反查接口，使用简单</li><li>消费者的逻辑如果无法通过重试成功，那么还需要更多的机制，来回滚操作</li></ul><p>适用于可异步执行的业务，且后续操作无需回滚的业务</p><p>如果读者想要进一步研究事务消息，可参考 rocketmq，为了方便大家学习事务消息，DTM 也提供了简单实现</p><h2 id="7最大努力通知"><a class="anchor" href="#7最大努力通知">#</a> 7. 最大努力通知</h2><p>发起通知方通过一定的机制最大努力将业务处理结果通知到接收方。具体包括：</p><p>有一定的消息重复通知机制。因为接收通知方可能没有接收到通知，此时要有一定的机制对消息重复通知。</p><p>消息校对机制。如果尽最大努力也没有通知到接收方，或者接收方消费消息后要再次消费，此时可由接收方主动向通知方查询消息信息来满足需求。</p><p>前面介绍的的本地消息表和事务消息都属于可靠消息，与这里介绍的最大努力通知有什么不同？</p><p>可靠消息一致性，发起通知方需要保证将消息发出去，并且将消息发到接收通知方，消息的可靠性关键由发起通知方来保证。</p><p>最大努力通知，发起通知方尽最大的努力将业务处理结果通知为接收通知方，但是可能消息接收不到，此时需要接收通知方主动调用发起通知方的接口查询业务处理结果，通知的可靠性关键在接收通知方。</p><p><strong>解决方案上，最大努力通知需要：</strong></p><ul><li>提供接口，让接受通知放能够通过接口查询业务处理结果</li><li>消息队列 ACK 机制，消息队列按照间隔 1min、5min、10min、30min、1h、2h、5h、10h 的方式，逐步拉大通知间隔 ，直到达到通知要求的时间窗口上限。之后不再通知</li></ul><p>最大努力通知适用于业务通知类型，例如微信交易的结果，就是通过最大努力通知方式通知各个商户，既有回调通知，也有交易查询接口</p><h2 id="8at事务模式"><a class="anchor" href="#8at事务模式">#</a> 8.AT 事务模式</h2><p>这是阿里开源项目 seata 中的一种事务模式，在蚂蚁金服也被称为 FMT。优点是该事务模式使用方式，类似 XA 模式，业务无需编写各类补偿操作，回滚由框架自动完成，缺点也类似 AT，存在较长时间的锁，不满足高并发的场景。有兴趣的同学可以参考 seata-AT</p><h1 id="三-分布式事务中的异常处理"><a class="anchor" href="#三-分布式事务中的异常处理">#</a> 三、分布式事务中的异常处理</h1><p>分布式事务中，会由于网络和业务异常问题导致 TM 和 RM 之间的通信问题，主要包括下面三类：</p><h2 id="空回滚"><a class="anchor" href="#空回滚">#</a> 空回滚</h2><p>在没有调用 TCC 资源 Try 方法的情况下，调用了二阶段的 Cancel 方法，Cancel 方法需要识别出这是一个空回滚，然后直接返回成功。</p><p>出现原因是当一个分支事务所在服务宕机或网络异常，分支事务调用记录为失败，这个时候其实是没有执行 Try 阶段，当故障恢复后，分布式事务进行回滚则会调用二阶段的 Cancel 方法，从而形成空回滚。</p><h2 id="幂等"><a class="anchor" href="#幂等">#</a> 幂等</h2><p>由于任何一个请求都可能出现网络异常，出现重复请求，所以所有的分布式事务分支，都需要保证幂等性</p><h2 id="悬挂"><a class="anchor" href="#悬挂">#</a> 悬挂</h2><p>悬挂就是对于一个分布式事务，其二阶段 Cancel 接口比 Try 接口先执行。</p><p>出现原因是在 RPC 调用分支事务 try 时，先注册分支事务，再执行 RPC 调用，如果此时 RPC 调用的网络发生拥堵，RPC 超时以后，TM 就会通知 RM 回滚该分布式事务，可能回滚完成后，RPC 请求才到达参与者真正执行。</p><blockquote><p>参考文章：<br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTI4MTE4MDUvYXJ0aWNsZS9kZXRhaWxzLzEyMTMxMzAwNg==">分布式事务七种解决方案，最后一种经典了！_独行侠梦的博客 - CSDN 博客</span><br><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNTYxNjgxMA==">分布式一致性之两阶段提交协议、三阶提交协议 - 知乎 (zhihu.com)</span></p></blockquote><div class="tags"><a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag"><i class="ic i-tag"></i> 微服务中间件</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" rel="tag"><i class="ic i-tag"></i> 分布式事务</a> <a href="/tags/Spring-Cloud/" rel="tag"><i class="ic i-tag"></i> Spring Cloud</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-06-29 16:22:29" itemprop="dateModified" datetime="2022-06-29T16:22:29+08:00">2022-06-29</time> </span><span id="article/62ceeeec.html" class="item leancloud_visitors" data-flag-title="分布式事务解决方案" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Bill Lee <i class="ic i-at"><em>@</em></i>Bill Lee's Blog</li><li class="link"><strong>本文链接：</strong> <a href="https://blog.liq2.com/article/62ceeeec" title="分布式事务解决方案">https://blog.liq2.com/article/62ceeeec</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/article/55b5aa61" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;008tmeFzly8h2p4sygmg8j31900u07ch.jpg" title="说一说微服务网关"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 微服务</span><h3>说一说微服务网关</h3></a></div><div class="item right"><a href="/article/ff29002e" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;008tmeFzly8h2cgwabff0j31hc0u07cu.jpg" title="解决hexo-shoka主题的流程图mermaid不能正常显示问题"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> Hexo</span><h3>解决hexo-shoka主题的流程图mermaid不能正常显示问题</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">一、基础概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.1.</span> <span class="toc-text">1. 事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.2.</span> <span class="toc-text">2. 分布式事务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">2.</span> <span class="toc-text">二、分布式事务解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4-two-phase-commit-%E5%8F%88%E7%A7%B0-xc"><span class="toc-number">2.1.</span> <span class="toc-text">1. 两阶段提交 (Two Phase Commit, 又称 XC)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#a%E4%B8%A4%E9%98%B6%E6%AE%B5%E8%AF%B4%E6%98%8E"><span class="toc-number">2.1.1.</span> <span class="toc-text">a. 两阶段说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-number">2.1.2.</span> <span class="toc-text">b. 两阶段提交的特点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E4%B8%89%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4three-phase-commit"><span class="toc-number">2.2.</span> <span class="toc-text">2. 三阶段提交 (Three Phase Commit)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#a%E4%B8%89%E9%98%B6%E6%AE%B5%E5%AE%9A%E4%B9%89"><span class="toc-number">2.2.1.</span> <span class="toc-text">a. 三阶段定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b%E5%85%B7%E4%BD%93%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">2.2.2.</span> <span class="toc-text">b. 具体执行过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3saga"><span class="toc-number">2.3.</span> <span class="toc-text">3.SAGA</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#a%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">2.3.1.</span> <span class="toc-text">a. 基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bsaga%E4%BA%8B%E5%8A%A1%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-number">2.3.2.</span> <span class="toc-text">b.SAGA 事务的特点：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4tcc-try-confirm-cancel"><span class="toc-number">2.4.</span> <span class="toc-text">4.TCC (Try-Confirm-Cancel)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#a%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-2"><span class="toc-number">2.4.1.</span> <span class="toc-text">a. 基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#btcc%E7%89%B9%E7%82%B9"><span class="toc-number">2.4.2.</span> <span class="toc-text">b.TCC 特点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E6%9C%AC%E5%9C%B0%E6%B6%88%E6%81%AF%E8%A1%A8"><span class="toc-number">2.5.</span> <span class="toc-text">5. 本地消息表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF"><span class="toc-number">2.6.</span> <span class="toc-text">6. 事务消息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E6%9C%80%E5%A4%A7%E5%8A%AA%E5%8A%9B%E9%80%9A%E7%9F%A5"><span class="toc-number">2.7.</span> <span class="toc-text">7. 最大努力通知</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8at%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.8.</span> <span class="toc-text">8.AT 事务模式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E4%B8%AD%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">三、分布式事务中的异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A9%BA%E5%9B%9E%E6%BB%9A"><span class="toc-number">3.1.</span> <span class="toc-text">空回滚</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%82%E7%AD%89"><span class="toc-number">3.2.</span> <span class="toc-text">幂等</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%82%AC%E6%8C%82"><span class="toc-number">3.3.</span> <span class="toc-text">悬挂</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/article/55b5aa61" rel="bookmark" title="说一说微服务网关">说一说微服务网关</a></li><li class="active"><a href="/article/62ceeeec" rel="bookmark" title="分布式事务解决方案">分布式事务解决方案</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Bill Lee" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Bill Lee</p><div class="description" itemprop="description">好记性不如烂笔头</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">11</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">11</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">18</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9jcmFiZXll" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;crabeye"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTEyNDc3NTU2" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;12477556"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20vY3JhYmV5ZQ==" title="https:&#x2F;&#x2F;weibo.com&#x2F;crabeye"><i class="ic i-weibo"></i></span> <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS9jcmFiZXll" title="https:&#x2F;&#x2F;about.me&#x2F;crabeye"><i class="ic i-address-card"></i></span> <span class="exturl item email" data-url="bWFpbHRvOnRpaHUyMDIyQHByb3Rvbi5tZQ==" title="mailto:tihu2022@proton.me"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li><li class="item"><a href="/atom.xml" rel="section"><i class="ic i-apple"></i>RSS订阅</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/article/55b5aa61" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/article/ff29002e" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/backend/" title="分类于 后端">后端</a> <i class="ic i-angle-right"></i> <a href="/categories/backend/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/backend/java/micro-service/" title="分类于 微服务">微服务</a></div><span><a href="/article/62ceeeec" title="分布式事务解决方案">分布式事务解决方案</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/comprehension/" title="分类于 感悟">感悟</a> <i class="ic i-angle-right"></i> <a href="/categories/comprehension/mood/" title="分类于 心情">心情</a></div><span><a href="/article/52cf48bf" title="开通博客第一天">开通博客第一天</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/backend/" title="分类于 后端">后端</a> <i class="ic i-angle-right"></i> <a href="/categories/backend/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/backend/java/micro-service/" title="分类于 微服务">微服务</a></div><span><a href="/article/55b5aa61" title="说一说微服务网关">说一说微服务网关</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/frontend/" title="分类于 前端">前端</a> <i class="ic i-angle-right"></i> <a href="/categories/frontend/tools/" title="分类于 工具">工具</a> <i class="ic i-angle-right"></i> <a href="/categories/frontend/tools/hexo/" title="分类于 Hexo">Hexo</a></div><span><a href="/article/ff29002e" title="解决hexo-shoka主题的流程图mermaid不能正常显示问题">解决hexo-shoka主题的流程图mermaid不能正常显示问题</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/frontend/" title="分类于 前端">前端</a> <i class="ic i-angle-right"></i> <a href="/categories/frontend/framework/" title="分类于 开发框架">开发框架</a> <i class="ic i-angle-right"></i> <a href="/categories/frontend/framework/tools/" title="分类于 工具">工具</a></div><span><a href="/article/3aeffd05" title="Alpine和eleventy搭配的基本使用">Alpine和eleventy搭配的基本使用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/frontend/" title="分类于 前端">前端</a> <i class="ic i-angle-right"></i> <a href="/categories/frontend/tools/" title="分类于 工具">工具</a> <i class="ic i-angle-right"></i> <a href="/categories/frontend/tools/hexo/" title="分类于 Hexo">Hexo</a></div><span><a href="/article/7d501b47" title="Hexo的aomori主题使用Remark42搭建文章评论功能">Hexo的aomori主题使用Remark42搭建文章评论功能</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/frontend/" title="分类于 前端">前端</a> <i class="ic i-angle-right"></i> <a href="/categories/frontend/tools/" title="分类于 工具">工具</a></div><span><a href="/article/7654e55b" title="各个管理端框架比较参考">各个管理端框架比较参考</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/backend/" title="分类于 后端">后端</a> <i class="ic i-angle-right"></i> <a href="/categories/backend/java/" title="分类于 Java">Java</a></div><span><a href="/article/955aeda8" title="JAVA多线程总结之一">JAVA多线程总结之一</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/frontend/" title="分类于 前端">前端</a> <i class="ic i-angle-right"></i> <a href="/categories/frontend/tools/" title="分类于 工具">工具</a></div><span><a href="/article/ffae4388" title="用jsDelivr和Github做免费的CDN加速">用jsDelivr和Github做免费的CDN加速</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/frontend/" title="分类于 前端">前端</a> <i class="ic i-angle-right"></i> <a href="/categories/frontend/fundation/" title="分类于 基础知识">基础知识</a></div><span><a href="/article/adf95138" title="Promise,async,await学习总结">Promise,async,await学习总结</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Bill Lee @ Climb Crab</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">26k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">23 分钟</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"article/62ceeeec.html",favicon:{show:"Climb Crab",hide:"Climb Crab"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,mermaid:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//fastly.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>